"""
VulnZero - Vulnerability Model
Stores detected vulnerabilities from scanners
"""

from datetime import datetime
from typing import Optional
from sqlalchemy import (
    Column, String, Integer, Float, DateTime, Text, JSON, Enum,
    Index, CheckConstraint
)
from sqlalchemy.orm import relationship
import enum

from shared.models.base import Base


class VulnerabilityStatus(str, enum.Enum):
    """Vulnerability status enumeration"""
    NEW = "new"
    ANALYZING = "analyzing"
    PATCH_GENERATED = "patch_generated"
    TESTING = "testing"
    PENDING_APPROVAL = "pending_approval"
    APPROVED = "approved"
    DEPLOYING = "deploying"
    DEPLOYED = "deployed"
    REMEDIATED = "remediated"
    FAILED = "failed"
    IGNORED = "ignored"


class VulnerabilitySeverity(str, enum.Enum):
    """Vulnerability severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class Vulnerability(Base):
    """
    Vulnerability Model - Stores detected vulnerabilities.

    This table stores all vulnerabilities discovered by various scanners,
    enriched with additional context and prioritization data.
    """

    __tablename__ = "vulnerabilities"

    # ========================================================================
    # CVE Information
    # ========================================================================
    cve_id = Column(
        String(50),
        nullable=False,
        index=True,
        unique=False,  # Same CVE can affect multiple assets
        comment="CVE identifier (e.g., CVE-2024-12345)"
    )

    title = Column(
        String(500),
        nullable=False,
        comment="Vulnerability title/summary"
    )

    description = Column(
        Text,
        nullable=True,
        comment="Detailed vulnerability description"
    )

    # ========================================================================
    # Severity & Scoring
    # ========================================================================
    severity = Column(
        Enum(VulnerabilitySeverity),
        nullable=False,
        index=True,
        comment="Severity level: critical, high, medium, low, info"
    )

    cvss_score = Column(
        Float,
        nullable=True,
        comment="CVSS v3 base score (0.0-10.0)"
    )

    cvss_vector = Column(
        String(200),
        nullable=True,
        comment="CVSS vector string"
    )

    epss_score = Column(
        Float,
        nullable=True,
        comment="Exploit Prediction Scoring System score (0.0-1.0)"
    )

    priority_score = Column(
        Float,
        nullable=False,
        default=0.0,
        index=True,
        comment="ML-calculated priority score for remediation (0-100)"
    )

    # ========================================================================
    # Status & Tracking
    # ========================================================================
    status = Column(
        Enum(VulnerabilityStatus),
        nullable=False,
        default=VulnerabilityStatus.NEW,
        index=True,
        comment="Current status of vulnerability remediation"
    )

    discovered_at = Column(
        DateTime(timezone=True),
        nullable=False,
        index=True,
        comment="When vulnerability was first discovered"
    )

    remediated_at = Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="When vulnerability was successfully remediated"
    )

    # ========================================================================
    # Affected Components
    # ========================================================================
    affected_package = Column(
        String(200),
        nullable=True,
        index=True,
        comment="Name of affected software package"
    )

    affected_version = Column(
        String(100),
        nullable=True,
        comment="Vulnerable version of the package"
    )

    fixed_version = Column(
        String(100),
        nullable=True,
        comment="Version that fixes the vulnerability"
    )

    # ========================================================================
    # Scanner Information
    # ========================================================================
    scanner_source = Column(
        String(100),
        nullable=False,
        index=True,
        comment="Source scanner (wazuh, qualys, tenable, etc.)"
    )

    scanner_id = Column(
        String(200),
        nullable=True,
        comment="ID from the scanner system"
    )

    raw_data = Column(
        JSON,
        nullable=True,
        comment="Raw vulnerability data from scanner (for debugging)"
    )

    # ========================================================================
    # Enrichment Data
    # ========================================================================
    exploit_available = Column(
        Integer,
        nullable=False,
        default=0,
        comment="Whether public exploits are available (0=no, 1=yes)"
    )

    exploit_urls = Column(
        JSON,
        nullable=True,
        comment="List of URLs to public exploits"
    )

    references = Column(
        JSON,
        nullable=True,
        comment="List of reference URLs (NVD, vendor advisories, etc.)"
    )

    cwe_ids = Column(
        JSON,
        nullable=True,
        comment="List of CWE (Common Weakness Enumeration) IDs"
    )

    tags = Column(
        JSON,
        nullable=True,
        comment="Custom tags for categorization"
    )

    # ========================================================================
    # Business Context
    # ========================================================================
    business_criticality = Column(
        Integer,
        nullable=False,
        default=5,
        comment="Business criticality score (1-10)"
    )

    public_exposure = Column(
        Integer,
        nullable=False,
        default=0,
        comment="Whether asset is publicly exposed (0=no, 1=yes)"
    )

    notes = Column(
        Text,
        nullable=True,
        comment="Additional notes or comments"
    )

    # ========================================================================
    # Approval & Assignment
    # ========================================================================
    assigned_to = Column(
        String(200),
        nullable=True,
        comment="User or team assigned to handle this vulnerability"
    )

    approved_by = Column(
        String(200),
        nullable=True,
        comment="User who approved remediation"
    )

    approved_at = Column(
        DateTime(timezone=True),
        nullable=True,
        comment="When remediation was approved"
    )

    # ========================================================================
    # Relationships
    # ========================================================================
    # One vulnerability can affect multiple assets (through association table)
    # One vulnerability can have multiple patches (retries, different approaches)
    patches = relationship("Patch", back_populates="vulnerability", cascade="all, delete-orphan")

    # ========================================================================
    # Table Constraints
    # ========================================================================
    __table_args__ = (
        # Composite indexes for common queries
        Index("ix_vuln_status_severity", "status", "severity"),
        Index("ix_vuln_status_priority", "status", "priority_score"),
        Index("ix_vuln_discovered_status", "discovered_at", "status"),
        Index("ix_vuln_cve_scanner", "cve_id", "scanner_source"),

        # Check constraints
        CheckConstraint("cvss_score >= 0.0 AND cvss_score <= 10.0", name="check_cvss_range"),
        CheckConstraint("epss_score >= 0.0 AND epss_score <= 1.0", name="check_epss_range"),
        CheckConstraint("priority_score >= 0.0 AND priority_score <= 100.0", name="check_priority_range"),
        CheckConstraint("business_criticality >= 1 AND business_criticality <= 10", name="check_criticality_range"),

        {"comment": "Stores detected vulnerabilities from various scanners with enrichment data"}
    )

    def __repr__(self) -> str:
        """String representation"""
        return f"<Vulnerability(id={self.id}, cve_id={self.cve_id}, status={self.status}, severity={self.severity})>"

    @property
    def age_days(self) -> int:
        """Calculate age of vulnerability in days"""
        if self.discovered_at:
            return (datetime.utcnow() - self.discovered_at).days
        return 0

    @property
    def is_critical(self) -> bool:
        """Check if vulnerability is critical"""
        return self.severity == VulnerabilitySeverity.CRITICAL

    @property
    def is_high_priority(self) -> bool:
        """Check if vulnerability is high priority (score > 70)"""
        return self.priority_score > 70

    @property
    def has_exploit(self) -> bool:
        """Check if public exploit is available"""
        return bool(self.exploit_available)

    @property
    def is_remediated(self) -> bool:
        """Check if vulnerability has been remediated"""
        return self.status == VulnerabilityStatus.REMEDIATED

    @property
    def needs_approval(self) -> bool:
        """Check if vulnerability needs approval"""
        return self.status == VulnerabilityStatus.PENDING_APPROVAL

# ============================================================================
# VulnZero - Staging Environment Configuration
# ============================================================================
# IMPORTANT: Copy this file to .env.staging and update all CHANGE_ME values
# Staging should mirror production as closely as possible
#
# Purpose:
# - Test production deployments before going live
# - Validate migrations and configuration changes
# - Performance testing and load testing
# - Integration testing with external services
# ============================================================================

# ----------------------------------------------------------------------------
# Environment
# ----------------------------------------------------------------------------
ENVIRONMENT=staging
VERSION=1.0.0-rc
DATA_PATH=/var/lib/vulnzero-staging

# ----------------------------------------------------------------------------
# Database Configuration
# ----------------------------------------------------------------------------
DATABASE_NAME=vulnzero_staging
DATABASE_USER=vulnzero_staging
DATABASE_PASSWORD=CHANGE_ME_STAGING_PASSWORD_$(openssl rand -hex 16)
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_URL=postgresql+asyncpg://${DATABASE_USER}:${DATABASE_PASSWORD}@${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}

# Database Connection Pool
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=10
DATABASE_POOL_TIMEOUT=30
DATABASE_POOL_RECYCLE=3600

# ----------------------------------------------------------------------------
# Redis Configuration
# ----------------------------------------------------------------------------
REDIS_PASSWORD=CHANGE_ME_STAGING_REDIS_PASSWORD_$(openssl rand -hex 16)
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_URL=redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/${REDIS_DB}

# ----------------------------------------------------------------------------
# Celery Configuration
# ----------------------------------------------------------------------------
CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/1
CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/2
CELERY_WORKER_CONCURRENCY=4
CELERY_TASK_TIME_LIMIT=3600
CELERY_TASK_SOFT_TIME_LIMIT=3300

# ----------------------------------------------------------------------------
# Authentication & Security
# ----------------------------------------------------------------------------
JWT_SECRET_KEY=CHANGE_ME_STAGING_JWT_SECRET_$(openssl rand -hex 32)
API_SECRET_KEY=CHANGE_ME_STAGING_API_SECRET_$(openssl rand -hex 32)
API_ALGORITHM=HS256

ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# CORS Settings (comma-separated)
CORS_ORIGINS=https://staging.vulnzero.example.com,https://staging-app.vulnzero.example.com
CORS_ALLOW_CREDENTIALS=true

# Rate Limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_PER_MINUTE=100  # More permissive for testing
RATE_LIMIT_BURST=20

# ----------------------------------------------------------------------------
# LLM API Keys (Use separate test accounts)
# ----------------------------------------------------------------------------
OPENAI_API_KEY=CHANGE_ME_STAGING_OPENAI_KEY
ANTHROPIC_API_KEY=CHANGE_ME_STAGING_ANTHROPIC_KEY

DEFAULT_LLM_PROVIDER=openai
LLM_TIMEOUT=60
LLM_MAX_RETRIES=3
LLM_SANITIZATION_LEVEL=MODERATE

# ----------------------------------------------------------------------------
# External Integrations (Use test/sandbox accounts)
# ----------------------------------------------------------------------------
NVD_API_KEY=CHANGE_ME_STAGING_NVD_KEY
NVD_API_URL=https://services.nvd.nist.gov/rest/json/cves/2.0

WAZUH_API_URL=https://staging-wazuh.example.com
WAZUH_API_USERNAME=staging_user
WAZUH_API_PASSWORD=CHANGE_ME_STAGING_WAZUH_PASSWORD

QUALYS_API_URL=https://qualysapi.qg2.apps.qualys.com
QUALYS_USERNAME=staging_qualys
QUALYS_PASSWORD=CHANGE_ME_STAGING_QUALYS_PASSWORD

TENABLE_API_URL=https://cloud.tenable.com
TENABLE_ACCESS_KEY=CHANGE_ME_STAGING_TENABLE_ACCESS_KEY
TENABLE_SECRET_KEY=CHANGE_ME_STAGING_TENABLE_SECRET_KEY

# ----------------------------------------------------------------------------
# Monitoring & Observability
# ----------------------------------------------------------------------------
SENTRY_DSN=CHANGE_ME_STAGING_SENTRY_DSN
SENTRY_ENVIRONMENT=staging
SENTRY_TRACES_SAMPLE_RATE=1.0  # 100% tracing in staging

PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus

GRAFANA_ADMIN_USER=staging_admin
GRAFANA_ADMIN_PASSWORD=CHANGE_ME_STAGING_GRAFANA_PASSWORD_$(openssl rand -hex 16)
GRAFANA_SECRET_KEY=CHANGE_ME_STAGING_GRAFANA_SECRET_$(openssl rand -hex 16)
GRAFANA_ROOT_URL=https://grafana-staging.vulnzero.example.com

PGADMIN_EMAIL=staging-admin@vulnzero.example.com
PGADMIN_PASSWORD=CHANGE_ME_STAGING_PGADMIN_PASSWORD_$(openssl rand -hex 16)

FLOWER_BASIC_AUTH=staging_admin:CHANGE_ME_STAGING_FLOWER_PASSWORD
FLOWER_PORT=5555

# ----------------------------------------------------------------------------
# Application Settings
# ----------------------------------------------------------------------------
LOG_LEVEL=DEBUG  # More verbose logging in staging
DEBUG=false  # Still false for production-like behavior
TESTING=false

API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=2  # Fewer workers in staging
API_MAX_REQUESTS=1000
API_MAX_REQUESTS_JITTER=100

MAX_UPLOAD_SIZE_MB=100
UPLOAD_DIR=/app/uploads

DEFAULT_PAGE_SIZE=50
MAX_PAGE_SIZE=100

# ----------------------------------------------------------------------------
# Deployment Settings
# ----------------------------------------------------------------------------
DEPLOYMENT_STRATEGY=canary
CANARY_PERCENTAGE=50  # More aggressive in staging
ROLLBACK_ON_ERROR=true
HEALTH_CHECK_INTERVAL=30
HEALTH_CHECK_TIMEOUT=10
HEALTH_CHECK_RETRIES=3

# ----------------------------------------------------------------------------
# Backup Configuration
# ----------------------------------------------------------------------------
BACKUP_ENABLED=true
BACKUP_SCHEDULE="0 3 * * *"  # Daily at 3 AM
BACKUP_RETENTION_DAYS=7  # Shorter retention in staging
BACKUP_PATH=/backups

BACKUP_S3_ENABLED=true
BACKUP_S3_BUCKET=vulnzero-backups-staging
BACKUP_S3_REGION=us-east-1
AWS_ACCESS_KEY_ID=CHANGE_ME_STAGING_AWS_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=CHANGE_ME_STAGING_AWS_SECRET_KEY

# ----------------------------------------------------------------------------
# Email Configuration (Use test SMTP)
# ----------------------------------------------------------------------------
SMTP_ENABLED=true
SMTP_HOST=smtp.mailtrap.io  # or your test SMTP
SMTP_PORT=2525
SMTP_USER=staging_smtp_user
SMTP_PASSWORD=CHANGE_ME_STAGING_SMTP_PASSWORD
SMTP_FROM_EMAIL=staging@vulnzero.example.com
SMTP_FROM_NAME=VulnZero Staging
SMTP_USE_TLS=true

# ----------------------------------------------------------------------------
# Alert Configuration
# ----------------------------------------------------------------------------
ALERT_EMAIL_ENABLED=true
ALERT_SLACK_ENABLED=true
ALERT_PAGERDUTY_ENABLED=false  # Disabled in staging

SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/STAGING/WEBHOOK
PAGERDUTY_API_KEY=  # Not used in staging
PAGERDUTY_SERVICE_ID=

# ----------------------------------------------------------------------------
# Feature Flags (Test new features in staging first)
# ----------------------------------------------------------------------------
FEATURE_AUTO_PATCH_ENABLED=true  # Can test in staging
FEATURE_AI_POWERED_PATCHING=true
FEATURE_MULTI_TENANCY=false
FEATURE_AUDIT_LOGGING=true
FEATURE_RATE_LIMITING=true

# ----------------------------------------------------------------------------
# Performance Tuning
# ----------------------------------------------------------------------------
WORKERS=2
WORKER_CLASS=uvicorn.workers.UvicornWorker
WORKER_CONNECTIONS=500
WORKER_TIMEOUT=30
GRACEFUL_TIMEOUT=30
KEEP_ALIVE=5

CACHE_ENABLED=true
CACHE_TTL=300
CACHE_MAX_SIZE=500

# ----------------------------------------------------------------------------
# SSL/TLS Configuration
# ----------------------------------------------------------------------------
SSL_ENABLED=true
SSL_CERT_PATH=/etc/ssl/certs/staging.vulnzero.crt
SSL_KEY_PATH=/etc/ssl/private/staging.vulnzero.key
SSL_CA_CERT_PATH=/etc/ssl/certs/ca-bundle.crt

# ----------------------------------------------------------------------------
# Compliance & Audit
# ----------------------------------------------------------------------------
AUDIT_LOG_ENABLED=true
AUDIT_LOG_PATH=/var/log/vulnzero/audit.log
AUDIT_LOG_RETENTION_DAYS=90
PII_ENCRYPTION_ENABLED=true
GDPR_COMPLIANCE=true

# ----------------------------------------------------------------------------
# Testing & QA Specific
# ----------------------------------------------------------------------------
# Enable additional testing features
ENABLE_TEST_ENDPOINTS=true  # Endpoints for testing only
MOCK_EXTERNAL_APIS=false  # Set to true for isolated testing
PERFORMANCE_LOGGING=true  # Detailed performance metrics
SLOW_QUERY_THRESHOLD_MS=1000  # Log queries > 1s

# Load Testing
MAX_CONCURRENT_USERS=100
LOAD_TEST_DURATION_MINUTES=30

# Data Seeding
SEED_DATABASE_ON_START=false
SEED_DATA_FILE=/app/data/staging-seed.json
